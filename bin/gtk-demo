#!/usr/bin/python
import sys, time
import pygtk
pygtk.require("2.0")
import gtk, gobject
from snes import core

libsnes_path, game_path = sys.argv[1:]

core.init(libsnes_path)

with open(game_path, "rb") as handle:
	core.load_cartridge_normal(handle.read())

window = gtk.Window(gtk.WINDOW_TOPLEVEL)
vbox = gtk.VBox()
canvas = gtk.DrawingArea()

window.set_title("bsnes/Python")

window.add(vbox)
vbox.show()

canvas.set_size_request(256, 224)
vbox.pack_start(canvas)
canvas.show()

window.show()

def paint_frame(data, pitch, line, width, height):
	drawable = canvas.window
	gc = canvas.get_style().fg_gc[gtk.STATE_NORMAL]
	colormap = gc.get_colormap()

	for y in range(height):
		line_width = line[y]
		for x in range(line_width):
			# pitch is in bytes, not pixels! Pity there's no good way to deal
			# with that.
			pixel_data = data[(pitch/2) * y + x]
			r = (pixel_data & 0x001f) << 11
			g = (pixel_data & 0x03e0) << 6
			b = (pixel_data & 0x7c00) << 1

			c = colormap.alloc_color(r, g, b)
			gc.set_foreground(c)
			gc.set_background(c)
			drawable.draw_point(gc, x, y)

core.set_video_refresh(paint_frame)

timeout_handle = gobject.timeout_add(1, lambda: core.run() or True)

def shutdown(widget, data=None):
	gobject.source_remove(timeout_handle)
	gtk.main_quit()

window.connect("destroy", shutdown)

gtk.main()
